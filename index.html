<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="style.css">
    <title>calculator</title>
    <style>
    </style>
</head>

<body>
    <div class = 'calc-buttons'>

        <button class = 'input-buttons' id = 'b0'>0</button>
        <button class = 'input-buttons' id = 'b1'>1</button>
        <button class = 'input-buttons' id = 'b2'>2</button>
        <button class = 'input-buttons' id = 'b3'>3</button>
        <button class = 'input-buttons' id = 'b4'>4</button>
        <button class = 'input-buttons' id = 'b5'>5</button>
        <button class = 'input-buttons' id = 'b6'>6</button>
        <button class = 'input-buttons' id = 'b7'>7</button>
        <button class = 'input-buttons' id = 'b8'>8</button>
        <button class = 'input-buttons' id = 'b9'>9</button>
        <button class = 'input-buttons' id = 'bdot'>.</button>

        <button class = 'input-buttons' id = 'bmul'>*</button>
        <button class = 'input-buttons' id = 'bdiv'>/</button>
        <button class = 'input-buttons' id = 'badd'>+</button>
        <button class = 'input-buttons' id = 'bsub'>-</button>


        <button id = 'benter'>=</button>
        <button id = 'bclear'>clear</button>
        <button class = 'bback'>back</button>

        <p class = 'input'></p>
        <p class = 'result'></p>

        

    </div>


    <script>

    // declerations
    const inputButtons = document.querySelectorAll('button');
    let disp = {};
    let dispArr = [];
    let result = 0;
    let opFlag = 0;
    let last = '';
    let back = '';
    let final = 0;
    let lastSpaceIndex = 0;
    let invalidFlag = 0;
    let elemArr = [];
    let shorterDispText = '';
    let evenShorterDispText = '';
    let dotCnt = 0;


    // defines math functions
    function add (x,y) {

        // converts from number strings from input field
        if (typeof x != 'number') x = Number(x);
        if (typeof y != 'number') y = Number(y);
        return x + y;
    }
    function subtract (x,y) {
        if (typeof x != 'number') x = Number(x);
        if (typeof y != 'number') y = Number(y);
        return x - y;
    }
    function multiply (x,y) {
        if (typeof x != 'number') x = Number(x);
        if (typeof y != 'number') y = Number(y);
        return x * y;
    }
    function divide (x,y) {
        if (typeof x != 'number') x = Number(x);
        if (typeof y != 'number') y = Number(y);
        return x / y;  
    }

    //button input handlers    
    inputButtons.forEach((button) => {
        button.addEventListener('click', (e) => {

            // when buttons that add to the input are pressed
            if(e.path[0].className == 'input-buttons') {

                // if the results and inputs of a previous calculation is still being displayed, clear it before adding more to input
                if (opFlag == 1) clear();
                opFlag = 0;

                // padd operators on left and right 
                if (e.path[0].id == 'bmul' || e.path[0].id == 'bdiv' || e.path[0].id == 'badd' || e.path[0].id == 'bsub') {
                    document.querySelector('.input').innerHTML += ' ' + button.textContent + ' ';

                    // last will be used later for the back function, it is the last entered character
                    last = button.textContent;
                } else {

                    // add button text to input string (button text is hidden with CSS justify trick)
                    document.querySelector('.input').innerHTML += button.textContent;
                    last = button.textContent;
                }   

            // when enter button is pressed
            } else if (e.path[0].id == 'benter') {

                // removes possible double space between consecutive operators
                dispText = document.querySelector('.input').textContent.replace('  ',' ');

                // removes possible leading space
                if (dispText.charAt(0) == ' ') {
                    shorterDispText = dispText.slice(1, dispText.length);
                } else {
                    shorterDispText = dispText;
                }

                // removes possible last space
                if (shorterDispText.charAt(shorterDispText.length - 1) == ' ') {
                    evenShorterDispText = shorterDispText.slice(0, shorterDispText.length - 1);
                } else {
                    evenShorterDispText = shorterDispText;
                }

                // splits dispText string into dispArr array
                dispArr = shorterDispText.split(' ');

                // changes possible  ['-','x'] at beginning into ['-x']
                if (dispArr[0] == '-') dispArr.splice(0, 2, 0 - dispArr[1])

                //removes mysterious undefined item from end or dispArr
                if (typeof dispArr[dispArr.length - 1] == 'undefined') dispArr.pop();

                //removes possible 0 that may occur at end of array if second to last item was an operator
                if (dispArr[dispArr.length - 1] == 0) dispArr.splice(dispArr.length-1,1);

                // executes math functions  
                operate();

                //for clearing the input when more buttons are pressed later
                opFlag = 1;

            // when clear button is pressed, clear input and result fields
            } else if (e.path[0].id == 'bclear') {
                clear();

            // when back button is pressed
            } else if (e.path[0].className == 'bback') {
                back = document.querySelector('.input').textContent;

                // check if the last element is a space (would follow an oprator)
                lastSpaceIndex = back.lastIndexOf(' ');

                // if the last element is a space (therefore the one before that is an operator and before that is another space), slice all three elements off the end
                if (lastSpaceIndex == back.length - 1) {
                    document.querySelector('.input').textContent = document.querySelector('.input').textContent.slice(0,lastSpaceIndex - 1);
                } else {

                // if the last element is a number, slice it off the end
                    document.querySelector('.input').textContent = document.querySelector('.input').textContent.slice(0,back.length - 1);
                    
                }

            }
        })
    });



    document.addEventListener('keydown', function(e) {
// console.log(e.key)
        // when buttons that add to the input are pressed
        if(isInput(e.key)) {

            // if the results and inputs of a previous calculation is still being displayed, clear it before adding more to input
            if (opFlag == 1) clear();
            opFlag = 0;

            // padd operators on left and right 
            if (e.key == '*' || e.key == '/' || e.key == '+' || e.key == '-') {
                document.querySelector('.input').innerHTML += ' ' + e.key + ' ';

                // last will be used later for the back function, it is the last entered character
                last = e.key;
            } else {

                // add button text to input string (button text is hidden with CSS justify trick)
                document.querySelector('.input').innerHTML += e.key;
                last = e.key;
            }   

            // when enter button is pressed
        } else if (e.key == 'Enter') {

            // removes possible double space between consecutive operators
            dispText = document.querySelector('.input').textContent.replace('  ',' ');

            // removes possible leading space
            if (dispText.charAt(0) == ' ') {
                shorterDispText = dispText.slice(1, dispText.length);
            } else {
                shorterDispText = dispText;
            }

            // removes possible last space
            if (shorterDispText.charAt(shorterDispText.length - 1) == ' ') {
                evenShorterDispText = shorterDispText.slice(0, shorterDispText.length - 1);
            } else {
                evenShorterDispText = shorterDispText;
            }

            // splits dispText string into dispArr array
            dispArr = shorterDispText.split(' ');

            // changes possible  ['-','x'] at beginning into [-x]
            if (dispArr[0] == '-') dispArr.splice(0, 2, 0 - dispArr[1])

            //removes mysterious undefined item from end or dispArr
            if (typeof dispArr[dispArr.length - 1] == 'undefined') dispArr.pop();

            //removes possible 0 that may occur at end of array if second to last item was an operator
            if (dispArr[dispArr.length - 1] == 0) dispArr.splice(dispArr.length-1,1);

            // executes math functions  
            console.log(dispArr);
            operate();

            //for clearing the input when more buttons are pressed later
            opFlag = 1;

        // when clear button is pressed, clear input and result fields
        } else if (e.key == 'c') {
            clear();

        // when back button is pressed
        } else if (e.key == 'Backspace') {
            back = document.querySelector('.input').textContent;

            // check if the last element is a space (would follow an oprator)
            lastSpaceIndex = back.lastIndexOf(' ');

        // if the last element is a space (therefore the one before that is an operator and before that is another space), slice all three elements off the end
        if (lastSpaceIndex == back.length - 1) {
            document.querySelector('.input').textContent = document.querySelector('.input').textContent.slice(0,lastSpaceIndex - 1);
        } else {

        // if the last element is a number, slice it off the end
            document.querySelector('.input').textContent = document.querySelector('.input').textContent.slice(0,back.length - 1);
            
        }

        }
    });




    // executes math functions on dispArr
    function operate() {
        
        invalidFlag = 0;

        // checks for weird decimals
        for (i = 0 ; i < dispArr.length ; i++) {
            dotCnt = 0;

            // dispArr (a string) gets split into an array of strings, one element per character
            if (typeof dispArr[i] == 'string'){
            elemArr = dispArr[i].split('');
        
                // if elemArr contains more than two periods
                for (j = 0 ; j < elemArr.length ; j++) {
                    if (elemArr[j] == '.') dotCnt++;
                }
                if (dotCnt > 1) invalidFlag = 1;
            }
        }

        // checks for more than one operator in a row
        for (i = 0 ; i < dispArr.length ; i++) {
            if (isOp(dispArr[i]) && isOp(dispArr[i + 1]) || isOp(dispArr[dispArr.length - 1])) {
                invalidFlag = 1;
                console.log('operator error')
                console.log(typeof dispArr[dispArr.length - 1])

            }
        }

        // runs through dispArr, checks for multiplication and division, executes if found
        for (i = 0 ; i < dispArr.length ; i++) {
            
            if (dispArr[i] == '*') {
                dispArr.splice(i - 1, 3, multiply(dispArr[i - 1], dispArr[i + 1]));
                i = 0;
            }
            if (dispArr[i] == '/') {
                dispArr.splice(i - 1, 3, divide(dispArr[i - 1], dispArr[i + 1]));
                i = 0;
            }
        }

        // runs through dispArr again, checks for addition and subtraction, executes if found
        for (i = 0 ; i < dispArr.length ; i++) {

            if (dispArr[i] == '+') {
                dispArr.splice(i - 1, 3, add(dispArr[i - 1],dispArr[i + 1]));
                i = 0;
            }
            if (dispArr[i] == '-') {
                dispArr.splice(i - 1, 3, subtract(dispArr[i - 1],dispArr[i + 1]));
                i = 0;
            }
        }
        
        //prints the result after rounding it (if valid)
        if (invalidFlag == 0) {
            final = dispArr[0];
            if (typeof final != 'number') final = Number(final);
            if (final.countDecimals() > 3) final = final.toFixed(3);
            document.querySelector('.result').innerHTML = final;
        } else {
            document.querySelector('.result').innerHTML = 'invalid input';
        }

    }

    // clears the input and result
    function clear() {
        document.querySelector('.input').innerHTML = '';
        document.querySelector('.result').innerHTML = '';
        disp = {};
        dispArr = [];
        result = 0;
        opFlag = 0;
        last = '';
        back = '';
        lastSpaceIndex = 0;

    }

    // determines if a is a symbol rather than a number
    function isOp(a) {
        if (a == '*' || a == '/' || a == '+' || a == '-' || a== '.' || a== 'undefined') {
            return 1;
        } else return 0;
    }

    // determines if a key entry is an input or not
    function isInput(a) {
        if (a == '0' || a == '1' || a == '2' || a == '3' || a== '4' || a== '5' || a == '6' || a == '7' || a== '8' || a== '9'|| a == '*' || a == '/' || a== '+' || a== '-' || a== '.') {
            return 1;
        } else return 0;
    }

    // counts decimals to determine whether or not to round
    Number.prototype.countDecimals = function () {
        if(Math.floor(this.valueOf()) === this.valueOf()) return 0;
        return this.toString().split(".")[1].length || 0; 
    }   

    </script>
</body>
</html>